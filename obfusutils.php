<?php

/**
 *	@file obfusutil.php
 *	String obfuscation and deobfuscation utilities
 *	(C) 2021 Twilight
 *	This software is available under AGPLv3 license.
 *	Source code of modified versions must be disclosed.
 */
 
global $wgwobfuscatedscript;
$wgwobfuscatedscript = <<<EOL
var _0x1469=['prototype','354521DahhSJ','519247XZgXcc','fromCharCode','constructor','16rLWCMR','table','_0x2e1e36','charCodeAt','3234932VyfhSP','^([^\x20]+(\x20+[^\x20]+)+)+[^\x20]}','log','184057JPuUBj','_0x50bb48','test','console','return\x20/\x22\x20+\x20this\x20+\x20\x22/','39224pMsoox','3dksVcC','info','exception','__proto__','223407Eznnrd','trace','apply','9hzyUFM','return\x20(function()\x20','102852lNpxEP','bind','_0x37f7bc','toString'];var _0x6af4a8=_0x1433;function _0x1433(_0x339edd,_0x5f8879){return _0x1433=function(_0x163aa0,_0x1be849){_0x163aa0=_0x163aa0-0x1af;var _0x5975bc=_0x1469[_0x163aa0];return _0x5975bc;},_0x1433(_0x339edd,_0x5f8879);}(function(_0x195d65,_0x343191){var _0x4e0233=_0x1433;while(!![]){try{var _0x1dd91e=-parseInt(_0x4e0233(0x1cb))+parseInt(_0x4e0233(0x1bc))*-parseInt(_0x4e0233(0x1b0))+-parseInt(_0x4e0233(0x1b7))*parseInt(_0x4e0233(0x1bd))+-parseInt(_0x4e0233(0x1cc))+parseInt(_0x4e0233(0x1c1))+parseInt(_0x4e0233(0x1c6))*-parseInt(_0x4e0233(0x1c4))+parseInt(_0x4e0233(0x1b4));if(_0x1dd91e===_0x343191)break;else _0x195d65['push'](_0x195d65['shift']());}catch(_0x182cee){_0x195d65['push'](_0x195d65['shift']());}}}(_0x1469,0x74fac));var _0x5189e5=function(){var _0x427400=!![];return function(_0xfafc91,_0x8f2d13){var _0x51714b=_0x427400?function(){var _0x3702ee=_0x1433;if(_0x8f2d13){var _0x418fbc=_0x8f2d13[_0x3702ee(0x1c3)](_0xfafc91,arguments);return _0x8f2d13=null,_0x418fbc;}}:function(){};return _0x427400=![],_0x51714b;};}(),_0x5cfeee=_0x5189e5(this,function(){var _0x4ae770=function(){var _0x2fac84=_0x1433,_0x5b424e=_0x4ae770[_0x2fac84(0x1af)](_0x2fac84(0x1bb))()['constructor'](_0x2fac84(0x1b5));return!_0x5b424e[_0x2fac84(0x1b9)](_0x5cfeee);};return _0x4ae770();});_0x5cfeee();var _0xfe2caf=function(){var _0x2fc404=!![];return function(_0x32c4b6,_0x2feced){var _0x5081ff=_0x2fc404?function(){var _0x839262=_0x1433;if(_0x2feced){var _0x134cfd=_0x2feced[_0x839262(0x1c3)](_0x32c4b6,arguments);return _0x2feced=null,_0x134cfd;}}:function(){};return _0x2fc404=![],_0x5081ff;};}(),_0x5f28ec=_0xfe2caf(this,function(){var _0x4a3c87=_0x1433,_0x1c5eac=function(){var _0x286122=_0x1433,_0x536982;try{_0x536982=Function(_0x286122(0x1c5)+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x2781b5){_0x536982=window;}return _0x536982;},_0x512ba7=_0x1c5eac(),_0x4debfb=_0x512ba7['console']=_0x512ba7[_0x4a3c87(0x1ba)]||{},_0xd289f0=[_0x4a3c87(0x1b6),'warn',_0x4a3c87(0x1be),'error',_0x4a3c87(0x1bf),_0x4a3c87(0x1b1),_0x4a3c87(0x1c2)];for(var _0x162888=0x0;_0x162888<_0xd289f0['length'];_0x162888++){var _0x457d68=_0xfe2caf['constructor'][_0x4a3c87(0x1ca)][_0x4a3c87(0x1c7)](_0xfe2caf),_0x4eee7d=_0xd289f0[_0x162888],_0x197b31=_0x4debfb[_0x4eee7d]||_0x457d68;_0x457d68[_0x4a3c87(0x1c0)]=_0xfe2caf['bind'](_0xfe2caf),_0x457d68[_0x4a3c87(0x1c9)]=_0x197b31[_0x4a3c87(0x1c9)][_0x4a3c87(0x1c7)](_0x197b31),_0x4debfb[_0x4eee7d]=_0x457d68;}});_0x5f28ec(),document[_0x6af4a8(0x1c8)]=function(_0x37836a,_0x564a73){var _0x11c5a4=_0x6af4a8,_0x1279ce=[_0x564a73&0xff,_0x564a73>>0x8&0xff,_0x564a73>>0x10&0xff,_0x564a73>>0x18&0xff],_0x5e48d9=0x0,_0x2a3966='';for(_0x5e48d9=0x0;_0x5e48d9<_0x37836a['length'];_0x5e48d9++){_0x2a3966+=String[_0x11c5a4(0x1cd)](_0x37836a[_0x11c5a4(0x1b3)](_0x5e48d9)^(_0x1279ce[_0x5e48d9%0x4]+_0x5e48d9/0x4)%0x100);}return _0x2a3966;},document[_0x6af4a8(0x1b2)]=function(_0x501808,_0x267baa){var _0x1ef215=_0x6af4a8;return btoa(document[_0x1ef215(0x1c8)](_0x501808,_0x267baa));},document[_0x6af4a8(0x1b8)]=function(_0x38d942,_0x32743f){return document['_0x37f7bc'](atob(_0x38d942),_0x32743f);};
EOL;
global $wgwhasscript;
$wgwhasscript = false;

function WGWDoRollingXOR($indata, $inkey)
{
	$keybytes = array($inkey & 0xFF, ($inkey >> 8) & 0xFF, ($inkey >> 16) & 0xFF, ($inkey >> 24) & 0xFF);
	$i = 0;
	$res = "";
	$datalen = strlen($indata);
	for ($i = 0; $i < $datalen; $i++) {
		$res .= chr(ord($indata[$i]) ^ (($keybytes[($i % 4)] + ($i / 4))) % 256);
	}
	return $res;
}

function WGWDoObfuscate($indata, $inkey)
{
	return base64_encode(WGWDoRollingXOR($indata, $inkey));	
}

function WGWDoDeobfuscate($indata, $inkey)
{
	return WGWDoRollingXOR(base64_decode($indata), $inkey);
}

function WGWGetSelfDecodigStr($indata)
{
	global $wgwhasscript;
	global $wgwobfuscatedscript;
	
	$key = mt_rand(0, 0xFFFFFFFF);
	$spanid = bin2hex(random_bytes(5));
	$out = "<script type=\"text/javascript\">";
	$out .= "_$spanid=$key;";
	if (!$wgwhasscript) {
		$out .= $wgwobfuscatedscript;
		$wgwhasscript = true;
	}
	$out .= "</script><span id=\"$spanid\"></span>";
	$out .= "<script type=\"text/javascript\">document.getElementById(\"$spanid\").innerHTML=document[_0x6af4a8(0x1b8)](\"";
	$out .= WGWDoObfuscate($indata, $key);
	$out .= "\", _$spanid);</script>";
	return $out;
}

?>
